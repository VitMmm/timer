<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–∞–π–º–µ—Ä –∑–∞–¥–∞—á</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .add-task-form {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
      }

      .settings-panel {
        background: white;
        padding: 15px 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .settings-panel button {
        padding: 10px 20px;
        font-size: 14px;
      }

      .file-status {
        color: #666;
        font-size: 14px;
        margin-left: auto;
      }

      .settings-form {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        flex: 1;
      }

      .settings-form input {
        flex: 1;
        min-width: 200px;
        padding: 8px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
      }

      .settings-form input:focus {
        outline: none;
        border-color: #667eea;
      }

      .save-status {
        color: #48bb78;
        font-size: 12px;
        font-style: italic;
      }

      .form-group {
        display: flex;
        gap: 10px;
      }

      input[type='text'] {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      input[type='text']:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        padding: 12px 25px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      button:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      .tasks-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .task-item {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .task-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }

      .task-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .task-main-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .task-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .subtimers-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #f0f0f0;
      }

      .subtimers-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .subtimers-title {
        font-size: 14px;
        font-weight: 600;
        color: #666;
      }

      .btn-add-subtimer {
        padding: 6px 12px;
        font-size: 12px;
        background: #667eea;
      }

      .btn-add-subtimer:hover {
        background: #5568d3;
      }

      .subtimers-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .subtimer-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .subtimer-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .subtimer-name {
        font-size: 14px;
        color: #333;
        min-width: 120px;
      }

      .subtimer-time {
        font-size: 18px;
        font-weight: 700;
        color: #764ba2;
        font-variant-numeric: tabular-nums;
        min-width: 70px;
      }

      .subtimer-actions {
        display: flex;
        gap: 8px;
      }

      .subtimer-btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .subtimer-input {
        padding: 6px 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        flex: 1;
        max-width: 200px;
      }

      .subtimer-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .task-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .task-time {
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
        font-variant-numeric: tabular-nums;
      }

      .task-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .btn-start {
        background: #48bb78;
      }

      .btn-start:hover {
        background: #38a169;
      }

      .btn-stop {
        background: #f56565;
      }

      .btn-stop:hover {
        background: #e53e3e;
      }

      .btn-delete {
        background: #a0aec0;
        padding: 8px 15px;
        font-size: 14px;
      }

      .btn-delete:hover {
        background: #718096;
      }

      .empty-state {
        text-align: center;
        color: white;
        padding: 40px;
        font-size: 18px;
        opacity: 0.9;
      }

      @media (max-width: 600px) {
        .task-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .task-actions {
          width: 100%;
          justify-content: space-between;
        }

        .form-group {
          flex-direction: column;
        }

        .subtimer-item {
          flex-direction: column;
          align-items: flex-start;
        }

        .subtimer-actions {
          width: 100%;
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>‚è±Ô∏è –¢–∞–π–º–µ—Ä –∑–∞–¥–∞—á</h1>

      <div class="settings-panel">
        <button id="settingsBtn">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button id="reloadBtn" style="display: none">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∏–∑ GitHub</button>
        <div class="file-status" id="fileStatus">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ</div>
        <div class="save-status" id="saveStatus" style="display: none"></div>
      </div>

      <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3)">
          <h2 style="margin-bottom: 20px; color: #333">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub</h2>
          <div class="settings-form" style="flex-direction: column; align-items: stretch">
            <label style="margin-bottom: 5px; color: #666; font-size: 14px">GitHub —Ç–æ–∫–µ–Ω (Personal Access Token):</label>
            <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" />
            <label style="margin-top: 15px; margin-bottom: 5px; color: #666; font-size: 14px">–í–ª–∞–¥–µ–ª–µ—Ü —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:</label>
            <input type="text" id="repoOwner" placeholder="username" />
            <label style="margin-top: 15px; margin-bottom: 5px; color: #666; font-size: 14px">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:</label>
            <input type="text" id="repoName" placeholder="repository-name" />
            <label style="margin-top: 15px; margin-bottom: 5px; color: #666; font-size: 14px">–í–µ—Ç–∫–∞ (–∫—É–¥–∞ –ø–∏—Å–∞—Ç—å tasks.json):</label>
            <input type="text" id="repoBranch" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: gh-pages (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)" />
            <div style="margin-top: 20px; display: flex; gap: 10px">
              <button id="saveSettingsBtn" style="flex: 1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancelSettingsBtn" style="flex: 1; background: #a0aec0">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
          <p style="margin-top: 15px; font-size: 12px; color: #999; line-height: 1.5">
            –î–ª—è <strong>fine-grained</strong> —Ç–æ–∫–µ–Ω–∞ –≤–∫–ª—é—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –Ω—É–∂–Ω–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é –∏ –ø—Ä–∞–≤–∞ <strong>Contents: Read and write</strong>. –î–ª—è <strong>classic</strong> ‚Äî scope <strong>repo</strong>.
          </p>
        </div>
      </div>

      <div class="add-task-form">
        <div class="form-group">
          <input type="text" id="taskInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..." autocomplete="off" />
          <button id="addTaskBtn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>
      </div>

      <div class="tasks-list" id="tasksList">
        <div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</div>
      </div>
    </div>

    <script>
      // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á
      let tasks = [];
      let timers = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ —Ç–∞–π–º–µ—Ä–æ–≤
      let githubConfig = null; // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è GitHub API
      let fileSha = null; // SHA —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      let saveTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ owner –∏ repo –∏–∑ URL
      function detectGitHubInfo() {
        const hostname = window.location.hostname;
        const pathname = window.location.pathname;

        // –î–ª—è GitHub Pages: username.github.io –∏–ª–∏ username.github.io/repo-name
        if (hostname.includes('github.io')) {
          const parts = hostname.split('.');
          if (parts.length >= 3) {
            const owner = parts[0];
            // –ï—Å–ª–∏ pathname –Ω–µ –ø—É—Å—Ç–æ–π –∏ –Ω–µ –ø—Ä–æ—Å—Ç–æ "/", –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –ø–æ–¥–ø–∞–ø–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ä–µ–ø–æ
            let repo = pathname.split('/').filter((p) => p)[0];
            // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–ø–∞–ø–∫–∏, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ–±—ã—á–Ω–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è username.github.io
            if (!repo) {
              repo = `${owner}.github.io`;
            }
            return { owner, repo };
          }
        }
        return null;
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
      function loadSettings() {
        const saved = localStorage.getItem('githubConfig');
        if (saved) {
          githubConfig = JSON.parse(saved);
          updateFileStatus();
        } else {
          // –ü—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ URL
          const detected = detectGitHubInfo();
          if (detected) {
            githubConfig = { ...detected, token: '' };
          }
        }
      }

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ localStorage
      function saveSettings() {
        if (githubConfig) {
          localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–∞–π–ª–∞
      function updateFileStatus() {
        const statusEl = document.getElementById('fileStatus');
        const reloadBtn = document.getElementById('reloadBtn');
        if (githubConfig && githubConfig.token && githubConfig.owner && githubConfig.repo) {
          statusEl.textContent = '‚úÖ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ';
          statusEl.style.color = '#48bb78';
          reloadBtn.style.display = 'block';
        } else {
          statusEl.textContent = '‚ö†Ô∏è –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ';
          statusEl.style.color = '#f56565';
          reloadBtn.style.display = 'none';
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      function showSaveStatus(message, isError = false) {
        const statusEl = document.getElementById('saveStatus');
        statusEl.textContent = message;
        statusEl.style.color = isError ? '#f56565' : '#48bb78';
        statusEl.style.display = 'block';
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 3000);
      }

      function githubApiHeaders() {
        return {
          Authorization: `Bearer ${githubConfig.token}`,
          Accept: 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
        };
      }

      function githubContentsUrl(path) {
        const base = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${path}`;
        if (githubConfig.branch) {
          return `${base}?ref=${encodeURIComponent(githubConfig.branch)}`;
        }
        return base;
      }

      async function testGitHubAccess() {
        try {
          const repoResp = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}`, {
            headers: githubApiHeaders(),
          });

          if (!repoResp.ok) {
            const err = await repoResp.json().catch(() => ({}));
            const msg = err.message ? `: ${err.message}` : '';
            showSaveStatus(`‚úó –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ (${repoResp.status}${msg})`, true);
            return false;
          }

          const shaResp = await fetch(githubContentsUrl('tasks.json'), { headers: githubApiHeaders() });
          if (shaResp.status === 403) {
            const err = await shaResp.json().catch(() => ({}));
            const msg = err.message ? `: ${err.message}` : '';
            showSaveStatus(`‚úó 403: –ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ Contents${msg}`, true);
            return false;
          }
          return true;
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞:', error);
          showSaveStatus('‚úó –û—à–∏–±–∫–∞ —Å–µ—Ç–∏/–¥–æ—Å—Ç—É–ø–∞ –∫ GitHub API', true);
          return false;
        }
      }

      // –ü–æ–ª—É—á–∏—Ç—å SHA —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
      async function getFileSha() {
        if (!githubConfig) return null;
        try {
          const response = await fetch(githubContentsUrl('tasks.json'), { headers: githubApiHeaders() });
          if (response.ok) {
            const data = await response.json();
            return data.sha;
          }
          if (response.status === 403) {
            const err = await response.json().catch(() => ({}));
            const msg = err.message ? `: ${err.message}` : '';
            showSaveStatus(`‚úó 403: –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ Contents${msg}`, true);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è SHA:', error);
        }
        return null;
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ GitHub API
      async function autoSaveTasks() {
        if (!githubConfig || !githubConfig.token || !githubConfig.owner || !githubConfig.repo) {
          return;
        }

        // –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å API)
        if (saveTimeout) {
          clearTimeout(saveTimeout);
        }

        saveTimeout = setTimeout(async () => {
          try {
            const data = JSON.stringify(tasks, null, 2);
            const content = btoa(unescape(encodeURIComponent(data))); // Base64 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

            // –ü–æ–ª—É—á–∞–µ–º SHA —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
            if (!fileSha) {
              fileSha = await getFileSha();
            }

            const url = githubContentsUrl('tasks.json').split('?')[0];
            const body = {
              message: 'Auto-save tasks',
              content: content,
            };

            // –ï—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º SHA –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            if (fileSha) {
              body.sha = fileSha;
            }

            if (githubConfig.branch) {
              body.branch = githubConfig.branch;
            }

            const response = await fetch(url, {
              method: 'PUT',
              headers: {
                ...githubApiHeaders(),
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(body),
            });

            if (response.ok) {
              const result = await response.json();
              fileSha = result.content.sha;
              showSaveStatus('‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            } else if (response.status === 409) {
              // –ö–æ–Ω—Ñ–ª–∏–∫—Ç SHA - –ø–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π SHA –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É
              console.log('–ö–æ–Ω—Ñ–ª–∏–∫—Ç SHA, –ø–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π...');
              fileSha = await getFileSha();
              if (fileSha) {
                body.sha = fileSha;
                const retryResponse = await fetch(url, {
                  method: 'PUT',
                  headers: {
                    ...githubApiHeaders(),
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(body),
                });
                if (retryResponse.ok) {
                  const result = await retryResponse.json();
                  fileSha = result.content.sha;
                  showSaveStatus('‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)');
                } else {
                  const error = await retryResponse.json().catch(() => ({}));
                  const msg = error.message ? `: ${error.message}` : '';
                  showSaveStatus(`‚úó –û—à–∏–±–∫–∞ –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–∞ (${retryResponse.status}${msg})`, true);
                }
              } else {
                showSaveStatus('‚úó –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π SHA', true);
              }
            } else {
              const error = await response.json().catch(() => ({}));
              const msg = error.message ? `: ${error.message}` : '';
              console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', response.status, error);
              if (response.status === 403) {
                showSaveStatus(`‚úó 403: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞/–ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å Contents${msg}`, true);
              } else if (response.status === 404) {
                showSaveStatus(`‚úó 404: —Ä–µ–ø–æ/–≤–µ—Ç–∫–∞/–ø—É—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω${msg}`, true);
              } else {
                showSaveStatus(`‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (${response.status}${msg})`, true);
              }
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            showSaveStatus('‚úó –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', true);
          }
        }, 1000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –∏–∑ GitHub API
      async function loadTasksFromGitHub() {
        if (!githubConfig || !githubConfig.token) {
          return false;
        }
        try {
          const response = await fetch(githubContentsUrl('tasks.json'), {
            headers: githubApiHeaders(),
          });
          if (response.ok) {
            const data = await response.json();
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ base64
            const content = decodeURIComponent(escape(atob(data.content)));
            tasks = JSON.parse(content);
            // –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø–æ–¥—Ç–∞–π–º–µ—Ä–æ–≤ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á
            tasks.forEach((task) => {
              if (!task.subtimers) {
                task.subtimers = [];
              }
            });
            fileSha = data.sha;
            renderTasks();
            restoreTimers();
            console.log('–ó–∞–¥–∞—á–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ GitHub:', tasks.length);
            return true;
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ GitHub:', error);
        }
        return false;
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      async function loadTasksOnInit() {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ GitHub API (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
        const loadedFromGitHub = await loadTasksFromGitHub();

        if (!loadedFromGitHub) {
          // Fallback: –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
          try {
            const response = await fetch('./tasks.json');
            if (response.ok) {
              const data = await response.json();
              tasks = data;
              // –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø–æ–¥—Ç–∞–π–º–µ—Ä–æ–≤ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á
              tasks.forEach((task) => {
                if (!task.subtimers) {
                  task.subtimers = [];
                }
              });
              renderTasks();
              restoreTimers();
              // –ü–æ–ª—É—á–∞–µ–º SHA —Ñ–∞–π–ª–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
              if (githubConfig) {
                fileSha = await getFileSha();
              }
            }
          } catch (error) {
            // –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
            console.log('–§–∞–π–ª tasks.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞');
          }
        }
      }

      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫
      function showSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        if (githubConfig) {
          document.getElementById('githubToken').value = githubConfig.token || '';
          document.getElementById('repoOwner').value = githubConfig.owner || '';
          document.getElementById('repoName').value = githubConfig.repo || '';
          document.getElementById('repoBranch').value = githubConfig.branch || '';
        } else {
          // –ü—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ URL
          const detected = detectGitHubInfo();
          if (detected) {
            document.getElementById('repoOwner').value = detected.owner;
            document.getElementById('repoName').value = detected.repo;
          }
        }
      }

      function hideSettings() {
        document.getElementById('settingsModal').style.display = 'none';
      }

      async function saveSettingsAndClose() {
        const token = document.getElementById('githubToken').value.trim();
        const owner = document.getElementById('repoOwner').value.trim();
        const repo = document.getElementById('repoName').value.trim();
        const branch = document.getElementById('repoBranch').value.trim();

        if (!token || !owner || !repo) {
          alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
          return;
        }

        githubConfig = { token, owner, repo, branch };
        saveSettings();
        updateFileStatus();
        const ok = await testGitHubAccess();
        if (!ok) return;

        fileSha = await getFileSha();
        hideSettings();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        await loadTasksOnInit();
      }

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (—Å–µ–∫—É–Ω–¥—ã –≤ –ß–ß:–ú–ú:–°–°)
      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
      async function addTask() {
        const input = document.getElementById('taskInput');
        const taskName = input.value.trim();

        if (!taskName) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
          return;
        }

        const newTask = {
          id: Date.now(),
          name: taskName,
          time: 0,
          isRunning: false,
          subtimers: [],
        };

        tasks.push(newTask);
        input.value = '';
        await autoSaveTasks();
        renderTasks();
      }

      // –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞
      async function toggleTimer(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        if (task.isRunning) {
          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞
          task.isRunning = false;
          if (timers[taskId]) {
            clearInterval(timers[taskId]);
            delete timers[taskId];
          }
        } else {
          // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
          task.isRunning = true;
          timers[taskId] = setInterval(async () => {
            task.time++;
            updateTaskTime(taskId);
            await autoSaveTasks();
          }, 1000);
        }

        await autoSaveTasks();
        renderTasks();
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–¥–∞—á–∏
      function updateTaskTime(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        const taskElement = document.querySelector(`[data-task-id="${taskId}"] .task-time`);
        if (taskElement) {
          taskElement.textContent = formatTime(task.time);
        }
      }

      // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
      async function deleteTask(taskId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
          const task = tasks.find((t) => t.id === taskId);
          if (!task) return;

          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
          if (timers[taskId]) {
            clearInterval(timers[taskId]);
            delete timers[taskId];
          }

          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø–æ–¥—Ç–∞–π–º–µ—Ä–æ–≤
          if (task.subtimers) {
            task.subtimers.forEach((subtimer) => {
              const timerKey = `${taskId}_${subtimer.id}`;
              if (timers[timerKey]) {
                clearInterval(timers[timerKey]);
                delete timers[timerKey];
              }
            });
          }

          tasks = tasks.filter((t) => t.id !== taskId);
          await autoSaveTasks();
          renderTasks();
        }
      }

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–∞–π–º–µ—Ä–∞
      async function addSubtimer(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        const subtimerName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–∞–π–º–µ—Ä–∞:');
        if (!subtimerName || !subtimerName.trim()) return;

        if (!task.subtimers) {
          task.subtimers = [];
        }

        const newSubtimer = {
          id: Date.now() + Math.random(),
          name: subtimerName.trim(),
          time: 0,
          isRunning: false,
        };

        task.subtimers.push(newSubtimer);
        await autoSaveTasks();
        renderTasks();
      }

      // –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–¥—Ç–∞–π–º–µ—Ä–∞
      async function toggleSubtimer(taskId, subtimerId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task || !task.subtimers) return;

        const subtimer = task.subtimers.find((st) => st.id === subtimerId);
        if (!subtimer) return;

        const timerKey = `${taskId}_${subtimerId}`;

        if (subtimer.isRunning) {
          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–¥—Ç–∞–π–º–µ—Ä–∞
          subtimer.isRunning = false;
          if (timers[timerKey]) {
            clearInterval(timers[timerKey]);
            delete timers[timerKey];
          }
        } else {
          // –ó–∞–ø—É—Å–∫ –ø–æ–¥—Ç–∞–π–º–µ—Ä–∞
          subtimer.isRunning = true;
          timers[timerKey] = setInterval(async () => {
            subtimer.time++;
            updateSubtimerTime(taskId, subtimerId);
            await autoSaveTasks();
          }, 1000);
        }

        await autoSaveTasks();
        renderTasks();
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥—Ç–∞–π–º–µ—Ä–∞
      function updateSubtimerTime(taskId, subtimerId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task || !task.subtimers) return;

        const subtimer = task.subtimers.find((st) => st.id === subtimerId);
        if (!subtimer) return;

        const subtimerElement = document.querySelector(
          `[data-task-id="${taskId}"] [data-subtimer-id="${subtimerId}"] .subtimer-time`
        );
        if (subtimerElement) {
          subtimerElement.textContent = formatTime(subtimer.time);
        }
      }

      // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–∞–π–º–µ—Ä–∞
      async function deleteSubtimer(taskId, subtimerId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–¥—Ç–∞–π–º–µ—Ä?')) return;

        const task = tasks.find((t) => t.id === taskId);
        if (!task || !task.subtimers) return;

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
        const timerKey = `${taskId}_${subtimerId}`;
        if (timers[timerKey]) {
          clearInterval(timers[timerKey]);
          delete timers[timerKey];
        }

        task.subtimers = task.subtimers.filter((st) => st.id !== subtimerId);
        await autoSaveTasks();
        renderTasks();
      }

      // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
      function renderTasks() {
        const tasksList = document.getElementById('tasksList');

        if (tasks.length === 0) {
          tasksList.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</div>';
          return;
        }

        tasksList.innerHTML = tasks
          .map((task) => {
            const subtimersHtml = task.subtimers && task.subtimers.length > 0
              ? `
          <div class="subtimers-section">
            <div class="subtimers-header">
              <div class="subtimers-title">–ü–æ–¥—Ç–∞–π–º–µ—Ä—ã:</div>
              <button class="btn-add-subtimer" onclick="addSubtimer(${task.id})">
                + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∞–π–º–µ—Ä
              </button>
            </div>
            <div class="subtimers-list">
              ${task.subtimers
                .map(
                  (subtimer) => `
              <div class="subtimer-item" data-subtimer-id="${subtimer.id}">
                <div class="subtimer-info">
                  <div class="subtimer-name">${escapeHtml(subtimer.name)}</div>
                  <div class="subtimer-time">${formatTime(subtimer.time)}</div>
                </div>
                <div class="subtimer-actions">
                  <button 
                    class="subtimer-btn ${subtimer.isRunning ? 'btn-stop' : 'btn-start'}" 
                    onclick="toggleSubtimer(${task.id}, ${subtimer.id})"
                  >
                    ${subtimer.isRunning ? '‚è∏' : '‚ñ∂'}
                  </button>
                  <button 
                    class="subtimer-btn btn-delete" 
                    onclick="deleteSubtimer(${task.id}, ${subtimer.id})"
                  >
                    üóë
                  </button>
                </div>
              </div>
              `
                )
                .join('')}
            </div>
          </div>
        `
              : `
          <div class="subtimers-section">
            <div class="subtimers-header">
              <div class="subtimers-title">–ü–æ–¥—Ç–∞–π–º–µ—Ä—ã:</div>
              <button class="btn-add-subtimer" onclick="addSubtimer(${task.id})">
                + –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–∞–π–º–µ—Ä
              </button>
            </div>
          </div>
        `;

            return `
          <div class="task-item" data-task-id="${task.id}">
            <div class="task-header">
              <div class="task-main-info">
                <div class="task-name">${escapeHtml(task.name)}</div>
                <div class="task-time">${formatTime(task.time)}</div>
              </div>
              <div class="task-actions">
                <button 
                  class="${task.isRunning ? 'btn-stop' : 'btn-start'}" 
                  onclick="toggleTimer(${task.id})"
                >
                  ${task.isRunning ? '‚è∏ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å'}
                </button>
                <button class="btn-delete" onclick="deleteTask(${task.id})">
                  üóë –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>
            </div>
            ${subtimersHtml}
          </div>
        `;
          })
          .join('');
      }

      // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      function restoreTimers() {
        tasks.forEach((task) => {
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–π–º–µ—Ä
          if (task.isRunning) {
            task.isRunning = false;
          }
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø–æ–¥—Ç–∞–π–º–µ—Ä—ã
          if (task.subtimers) {
            task.subtimers.forEach((subtimer) => {
              if (subtimer.isRunning) {
                subtimer.isRunning = false;
              }
            });
          }
        });
        autoSaveTasks();
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      document.getElementById('addTaskBtn').addEventListener('click', addTask);
      document.getElementById('settingsBtn').addEventListener('click', showSettings);
      document.getElementById('reloadBtn').addEventListener('click', async () => {
        const loaded = await loadTasksFromGitHub();
        if (loaded) {
          showSaveStatus('‚úì –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ GitHub');
        } else {
          showSaveStatus('‚úó –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', true);
        }
      });
      document.getElementById('saveSettingsBtn').addEventListener('click', saveSettingsAndClose);
      document.getElementById('cancelSettingsBtn').addEventListener('click', hideSettings);

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
      document.getElementById('settingsModal').addEventListener('click', (e) => {
        if (e.target.id === 'settingsModal') {
          hideSettings();
        }
      });

      document.getElementById('taskInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addTask();
        }
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      loadSettings();
      loadTasksOnInit();
      updateFileStatus();
    </script>
  </body>
</html>
