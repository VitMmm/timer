<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–∞–π–º–µ—Ä –∑–∞–¥–∞—á</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .add-task-form {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
      }

      .file-controls {
        background: white;
        padding: 15px 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .file-controls button {
        padding: 10px 20px;
        font-size: 14px;
      }

      .file-status {
        color: #666;
        font-size: 14px;
        margin-left: auto;
      }

      .form-group {
        display: flex;
        gap: 10px;
      }

      input[type='text'] {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      input[type='text']:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        padding: 12px 25px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      button:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      .tasks-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .task-item {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: transform 0.2s;
      }

      .task-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }

      .task-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .task-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .task-time {
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
        font-variant-numeric: tabular-nums;
      }

      .task-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .btn-start {
        background: #48bb78;
      }

      .btn-start:hover {
        background: #38a169;
      }

      .btn-stop {
        background: #f56565;
      }

      .btn-stop:hover {
        background: #e53e3e;
      }

      .btn-delete {
        background: #a0aec0;
        padding: 8px 15px;
        font-size: 14px;
      }

      .btn-delete:hover {
        background: #718096;
      }

      .empty-state {
        text-align: center;
        color: white;
        padding: 40px;
        font-size: 18px;
        opacity: 0.9;
      }

      @media (max-width: 600px) {
        .task-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        .task-actions {
          width: 100%;
          justify-content: space-between;
        }

        .form-group {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>‚è±Ô∏è –¢–∞–π–º–µ—Ä –∑–∞–¥–∞—á</h1>

      <div class="file-controls">
        <button id="loadFileBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
        <button id="saveFileBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>
        <input type="file" id="fileInput" accept=".json" style="display: none" />
        <div class="file-status" id="fileStatus">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
      </div>

      <div class="add-task-form">
        <div class="form-group">
          <input type="text" id="taskInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..." autocomplete="off" />
          <button id="addTaskBtn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>
      </div>

      <div class="tasks-list" id="tasksList">
        <div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</div>
      </div>
    </div>

    <script>
      // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á
      let tasks = [];
      let timers = {}; // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ —Ç–∞–π–º–µ—Ä–æ–≤
      let fileHandle = null; // Handle –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–º —á–µ—Ä–µ–∑ File System Access API

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–∞–π–ª–∞
      function updateFileStatus() {
        const statusEl = document.getElementById('fileStatus');
        if (fileHandle) {
          statusEl.textContent = '–§–∞–π–ª –≤—ã–±—Ä–∞–Ω';
          statusEl.style.color = '#48bb78';
        } else {
          statusEl.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
          statusEl.style.color = '#666';
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –∏–∑ JSON —Ñ–∞–π–ª–∞
      async function loadTasksFromFile() {
        try {
          // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å File System Access API
          if ('showOpenFilePicker' in window) {
            [fileHandle] = await window.showOpenFilePicker({
              types: [
                {
                  description: 'JSON —Ñ–∞–π–ª—ã',
                  accept: { 'application/json': ['.json'] },
                },
              ],
            });
            const file = await fileHandle.getFile();
            const text = await file.text();
            tasks = JSON.parse(text);
            updateFileStatus();
            renderTasks();
            restoreTimers();
          } else {
            // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º input file
            document.getElementById('fileInput').click();
          }
        } catch (error) {
          if (error.name !== 'AbortError') {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
          }
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –∏–∑ input file (fallback)
      function loadTasksFromInput(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            tasks = JSON.parse(e.target.result);
            renderTasks();
            restoreTimers();
            updateFileStatus();
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', error);
            alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON.');
          }
        };
        reader.readAsText(file);
      }

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ JSON —Ñ–∞–π–ª
      async function saveTasksToFile() {
        try {
          const data = JSON.stringify(tasks, null, 2);

          // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å File System Access API
          if ('showSaveFilePicker' in window) {
            let handle = fileHandle;
            if (!handle) {
              handle = await window.showSaveFilePicker({
                types: [
                  {
                    description: 'JSON —Ñ–∞–π–ª—ã',
                    accept: { 'application/json': ['.json'] },
                  },
                ],
                suggestedName: 'tasks.json',
              });
              fileHandle = handle;
            }

            const writable = await handle.createWritable();
            await writable.write(data);
            await writable.close();
            updateFileStatus();
          } else {
            // Fallback: —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tasks.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }
        } catch (error) {
          if (error.name !== 'AbortError') {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
          }
        }
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –≤—ã–±—Ä–∞–Ω)
      async function autoSaveTasks() {
        if (fileHandle) {
          try {
            const data = JSON.stringify(tasks, null, 2);
            const writable = await fileHandle.createWritable();
            await writable.write(data);
            await writable.close();
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
          }
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å tasks.json)
      async function loadTasksOnInit() {
        try {
          // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å tasks.json —á–µ—Ä–µ–∑ fetch
          const response = await fetch('./tasks.json');
          if (response.ok) {
            const data = await response.json();
            tasks = data;
            renderTasks();
            restoreTimers();
            updateFileStatus();
          }
        } catch (error) {
          // –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
          console.log('–§–∞–π–ª tasks.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞');
        }
      }

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (—Å–µ–∫—É–Ω–¥—ã –≤ –ß–ß:–ú–ú:–°–°)
      function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
      async function addTask() {
        const input = document.getElementById('taskInput');
        const taskName = input.value.trim();

        if (!taskName) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
          return;
        }

        const newTask = {
          id: Date.now(),
          name: taskName,
          time: 0,
          isRunning: false,
        };

        tasks.push(newTask);
        input.value = '';
        await autoSaveTasks();
        renderTasks();
      }

      // –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞
      async function toggleTimer(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        if (task.isRunning) {
          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞
          task.isRunning = false;
          if (timers[taskId]) {
            clearInterval(timers[taskId]);
            delete timers[taskId];
          }
        } else {
          // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
          task.isRunning = true;
          timers[taskId] = setInterval(async () => {
            task.time++;
            updateTaskTime(taskId);
            await autoSaveTasks();
          }, 1000);
        }

        await autoSaveTasks();
        renderTasks();
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–¥–∞—á–∏
      function updateTaskTime(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        const taskElement = document.querySelector(`[data-task-id="${taskId}"] .task-time`);
        if (taskElement) {
          taskElement.textContent = formatTime(task.time);
        }
      }

      // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
      async function deleteTask(taskId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) {
          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
          if (timers[taskId]) {
            clearInterval(timers[taskId]);
            delete timers[taskId];
          }

          tasks = tasks.filter((t) => t.id !== taskId);
          await autoSaveTasks();
          renderTasks();
        }
      }

      // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
      function renderTasks() {
        const tasksList = document.getElementById('tasksList');

        if (tasks.length === 0) {
          tasksList.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</div>';
          return;
        }

        tasksList.innerHTML = tasks
          .map(
            (task) => `
          <div class="task-item" data-task-id="${task.id}">
            <div class="task-info">
              <div class="task-name">${escapeHtml(task.name)}</div>
              <div class="task-time">${formatTime(task.time)}</div>
            </div>
            <div class="task-actions">
              <button 
                class="${task.isRunning ? 'btn-stop' : 'btn-start'}" 
                onclick="toggleTimer(${task.id})"
              >
                ${task.isRunning ? '‚è∏ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å'}
              </button>
              <button class="btn-delete" onclick="deleteTask(${task.id})">
                üóë –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          </div>
        `,
          )
          .join('');
      }

      // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      function restoreTimers() {
        tasks.forEach((task) => {
          if (task.isRunning) {
            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–∞–π–º–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏—Ö –≤—Ä—É—á–Ω—É—é
            task.isRunning = false;
          }
        });
        autoSaveTasks();
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      document.getElementById('addTaskBtn').addEventListener('click', addTask);
      document.getElementById('loadFileBtn').addEventListener('click', loadTasksFromFile);
      document.getElementById('saveFileBtn').addEventListener('click', saveTasksToFile);
      document.getElementById('fileInput').addEventListener('change', loadTasksFromInput);

      document.getElementById('taskInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addTask();
        }
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      loadTasksOnInit();
      updateFileStatus();
    </script>
  </body>
</html>
